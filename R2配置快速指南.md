# R2 配置快速指南 🚀

## ⚡ 5 分钟快速配置

### 第 1 步：获取 R2 凭证（2分钟）

1. 访问 https://dash.cloudflare.com/
2. 左侧菜单选择 **R2**
3. 点击 **Create bucket** → 命名为 `studyhacks-ppt`
4. 点击 **Manage R2 API Tokens** → **Create API Token**
5. 权限选择 **Edit** → **Create API Token**
6. 记录下面的信息：
   ```
   Account ID: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   Access Key ID: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   Secret Access Key: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   ```

### 第 2 步：配置环境变量（1分钟）

在项目根目录的 `.env.local` 文件中添加（如果文件不存在就创建）：

```env
# R2 存储配置（必填）
R2_ACCOUNT_ID=你的Account_ID
R2_ACCESS_KEY=你的Access_Key_ID
R2_SECRET_KEY=你的Secret_Access_Key
R2_BUCKET_NAME=studyhacks-ppt

# 可选：自定义域名（如果你配置了 R2 自定义域名）
# R2_DOMAIN=https://cdn.yourdomain.com
```

### 第 3 步：重启服务（1分钟）

```bash
# 停止当前服务
# Ctrl + C

# 重新启动
pnpm dev
# 或
npm run dev
```

### 第 4 步：测试（1分钟）

1. 打开浏览器，访问你的网站
2. 登录账号
3. 生成一个 Infographic 或 PPT
4. 查看浏览器控制台或服务器日志，应该看到：
   ```
   [Infographic] 开始保存 1 张图片到 R2
   [Infographic] ✅ 图片 1 保存成功
   ```

✅ **完成！** 现在所有生成的内容都会自动保存到 R2 了！

## 📁 文件存储位置

生成的文件会保存在：
- **Infographic**: `studyhacks-ppt/infographic/{用户ID}/`
- **Slides**: `studyhacks-ppt/slides/{用户ID}/`

## 🔍 验证配置是否成功

### 方法 1：查看日志
生成内容时，在服务器日志中查找：
```
✅ 图片保存成功
✅ 已更新 ai_task 记录
```

### 方法 2：查看 R2 控制台
1. 登录 Cloudflare Dashboard
2. 进入 R2 → 你的桶
3. 查看是否有新文件上传

### 方法 3：查看数据库
```sql
-- 查看最新的 Infographic 记录
SELECT taskResult FROM ai_task 
WHERE scene = 'ai_infographic' 
ORDER BY createdAt DESC LIMIT 1;

-- 应该看到包含 R2 URL 的 JSON
```

## ❓ 常见问题

### Q1: 配置后没有自动保存？
**检查**：
1. `.env.local` 文件路径是否正确（应在项目根目录）
2. 环境变量名称是否完全一致（大小写敏感）
3. 是否重启了服务
4. 查看日志是否有错误信息

### Q2: 显示 "R2 未配置" 的日志？
**原因**：环境变量没有正确加载

**解决**：
1. 确认 `.env.local` 文件在项目根目录
2. 确认变量名称拼写正确
3. 重启开发服务器
4. 如果是生产环境，在部署平台（Vercel/Netlify）配置环境变量

### Q3: 保存失败但不影响使用？
**原因**：系统自动降级使用临时 URL

**影响**：用户仍可以看到图片，但可能几小时后失效

**解决**：检查 R2 配置和网络连接

### Q4: 费用会很高吗？
**不会！**
- 前 10GB 完全免费
- 超出部分只需 $0.015/GB/月
- **无流量费用**（这是重点！）
- 一般项目每月不到 $1

## 🎯 后续优化（可选）

### 配置自定义域名
1. 在 Cloudflare 中为 R2 配置自定义域名
2. 在 `.env.local` 中添加 `R2_DOMAIN=https://cdn.yourdomain.com`
3. 重启服务

好处：
- 更快的访问速度（使用 Cloudflare CDN）
- 更好的 SEO
- 自定义的 URL

### 配置 CORS（如果需要跨域访问）
1. 在 R2 桶设置中添加 CORS 规则
2. 允许你的域名访问

## 📞 需要帮助？

- 详细文档：`docs/R2配置说明.md`
- 技术实施：`docs/实施总结.md`
- Cloudflare R2: https://developers.cloudflare.com/r2/

---

**提示**: 如果不想用 R2，系统会自动使用临时 URL，功能不受影响（但图片可能会失效）。

