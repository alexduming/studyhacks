# R2 æŒä¹…åŒ–å­˜å‚¨åŠŸèƒ½ - å®æ–½æ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. **åˆ›å»ºä¿å­˜å›¾ç‰‡åˆ° R2 çš„ API**
**æ–‡ä»¶**: `src/app/api/storage/save-ai-image/route.ts`

è¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„å›¾ç‰‡ä¿å­˜ APIï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼š
- æ¥æ”¶ä¸´æ—¶å›¾ç‰‡ URL
- éªŒè¯ç”¨æˆ·èº«ä»½
- ä¸‹è½½å›¾ç‰‡å¹¶ä¸Šä¼ åˆ° R2
- æ”¯æŒä¸¤ç§ç±»å‹ï¼š`infographic` å’Œ `slide`
- è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
- æ”¯æŒè‡ªå®šä¹‰åŸŸå

### 2. **Infographic è‡ªåŠ¨ä¿å­˜å®ç°**
**æ–‡ä»¶**: `src/app/api/infographic/query-with-fallback/route.ts`

ä¿®æ”¹å†…å®¹ï¼š
- âœ… åœ¨æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€æˆåŠŸåï¼Œè‡ªåŠ¨ä¿å­˜å›¾ç‰‡åˆ° R2
- âœ… å¹¶è¡Œä¸‹è½½å’Œä¸Šä¼ å¤šå¼ å›¾ç‰‡
- âœ… æ›´æ–° `ai_task` è¡¨çš„ `taskResult` å­—æ®µ
- âœ… æ™ºèƒ½é™çº§ï¼šR2 æœªé…ç½®æˆ–ä¿å­˜å¤±è´¥æ—¶ä½¿ç”¨ä¸´æ—¶ URL
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•

å…³é”®ä»£ç ç‰‡æ®µï¼š
```typescript
// ä¿å­˜åˆ° R2ï¼šinfographic/{ç”¨æˆ·ID}/{æ—¶é—´æˆ³}_{éšæœºID}_{ç´¢å¼•}.png
const storageKey = `infographic/${user.id}/${fileName}`;

// æ›´æ–° ai_task è®°å½•
await db().update(aiTask).set({
  taskResult: JSON.stringify({
    imageUrls: savedUrls,
    originalUrls: result.resultUrls,
    savedToR2: true,
    savedAt: new Date().toISOString(),
  }),
  status: 'success',
}).where(eq(aiTask.id, existingTask.id));
```

### 3. **Slides/PPT è‡ªåŠ¨ä¿å­˜å®ç°**
**æ–‡ä»¶**: `src/app/actions/aippt.ts`

ä¿®æ”¹å‡½æ•°ï¼š`queryKieTaskWithFallbackAction`

ä¿®æ”¹å†…å®¹ï¼š
- âœ… åœ¨æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€æˆåŠŸåï¼Œè‡ªåŠ¨ä¿å­˜å›¾ç‰‡åˆ° R2
- âœ… æ”¯æŒ KIE å’Œ Replicate ä¸¤ç§æä¾›å•†
- âœ… å¹¶è¡Œä¸‹è½½å’Œä¸Šä¼ å¤šå¼ å›¾ç‰‡
- âœ… è¿”å› R2 æ°¸ä¹… URL
- âœ… å‰ç«¯è‡ªåŠ¨ä¿å­˜åˆ° `presentation` è¡¨

å…³é”®ä»£ç ç‰‡æ®µï¼š
```typescript
// ä¿å­˜åˆ° R2ï¼šslides/{ç”¨æˆ·ID}/{æ—¶é—´æˆ³}_{éšæœºID}_{ç´¢å¼•}.png
const storageKey = `slides/${user.id}/${fileName}`;

// è¿”å› R2 URL
return {
  data: {
    status: result.data.status,
    results: savedUrls,
  },
};
```

### 4. **é…ç½®æ–‡æ¡£**
åˆ›å»ºäº†ä¸¤ä»½é…ç½®æ–‡æ¡£ï¼š
- `docs/R2_STORAGE_SETUP.md`ï¼ˆè‹±æ–‡ï¼Œè¯¦ç»†ç‰ˆï¼‰
- `docs/R2é…ç½®è¯´æ˜.md`ï¼ˆä¸­æ–‡ï¼Œç®€æ´ç‰ˆï¼‰

## ğŸ“ æ–‡ä»¶ä¿®æ”¹æ¸…å•

### æ–°å¢æ–‡ä»¶
1. `src/app/api/storage/save-ai-image/route.ts` - ä¿å­˜å›¾ç‰‡åˆ° R2 çš„ API
2. `docs/R2_STORAGE_SETUP.md` - è‹±æ–‡é…ç½®æ–‡æ¡£
3. `docs/R2é…ç½®è¯´æ˜.md` - ä¸­æ–‡é…ç½®æ–‡æ¡£
4. `docs/å®æ–½æ€»ç»“.md` - æœ¬æ–‡ä»¶

### ä¿®æ”¹æ–‡ä»¶
1. `src/app/api/infographic/query-with-fallback/route.ts`
   - æ·»åŠ äº†è‡ªåŠ¨ä¿å­˜åˆ° R2 çš„é€»è¾‘
   - æ·»åŠ äº†æ›´æ–° ai_task è®°å½•çš„é€»è¾‘

2. `src/app/actions/aippt.ts`
   - ä¿®æ”¹äº† `queryKieTaskWithFallbackAction` å‡½æ•°
   - æ·»åŠ äº†è‡ªåŠ¨ä¿å­˜åˆ° R2 çš„é€»è¾‘

### æœªä¿®æ”¹çš„ç°æœ‰æ–‡ä»¶ï¼ˆå·²éªŒè¯ï¼‰
- `src/extensions/storage/r2.ts` - R2 Providerï¼ˆå·²å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨ï¼‰
- `src/extensions/storage/index.ts` - Storage Managerï¼ˆå·²å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨ï¼‰
- `src/shared/services/storage.ts` - Storage Serviceï¼ˆå·²å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨ï¼‰
- `src/config/db/schema.ts` - æ•°æ®åº“ Schemaï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
- `src/app/actions/presentation.ts` - Presentation Actionsï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

## ğŸ¯ å®ç°çš„åŠŸèƒ½

### Infographic æŒä¹…åŒ–æµç¨‹
```
ç”¨æˆ·ç”Ÿæˆ Infographic
    â†“
AI æä¾›å•†ç”Ÿæˆå›¾ç‰‡ï¼ˆä¸´æ—¶ URLï¼‰
    â†“
å‰ç«¯è½®è¯¢æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
    â†“
ã€åç«¯ã€‘æŸ¥è¯¢åˆ° SUCCESS åï¼š
    â”œâ”€ ä¸‹è½½ä¸´æ—¶å›¾ç‰‡
    â”œâ”€ ä¸Šä¼ åˆ° R2: infographic/{ç”¨æˆ·ID}/xxx.png
    â”œâ”€ æ›´æ–° ai_task è¡¨ï¼Œä¿å­˜ R2 URL
    â””â”€ è¿”å› R2 æ°¸ä¹… URL
    â†“
å‰ç«¯æ˜¾ç¤ºå›¾ç‰‡ï¼ˆæ°¸ä¹… URLï¼‰
    â†“
ç”¨æˆ·åœ¨å†å²è®°å½•ä¸­æŸ¥çœ‹
```

### Slides/PPT æŒä¹…åŒ–æµç¨‹
```
ç”¨æˆ·ç”Ÿæˆ PPTï¼ˆå¤šå¼ å¹»ç¯ç‰‡ï¼‰
    â†“
å¹¶è¡Œä¸ºæ¯å¼ å¹»ç¯ç‰‡ç”Ÿæˆå›¾ç‰‡
    â†“
ã€å‰ç«¯ã€‘è½®è¯¢æŸ¥è¯¢æ¯å¼ å›¾ç‰‡çš„ä»»åŠ¡çŠ¶æ€
    â†“
ã€åç«¯ã€‘æ¯å¼ å›¾ç‰‡ SUCCESS åï¼š
    â”œâ”€ ä¸‹è½½ä¸´æ—¶å›¾ç‰‡
    â”œâ”€ ä¸Šä¼ åˆ° R2: slides/{ç”¨æˆ·ID}/xxx.png
    â””â”€ è¿”å› R2 æ°¸ä¹… URL
    â†“
ã€å‰ç«¯ã€‘æ‰€æœ‰å›¾ç‰‡å®Œæˆåï¼š
    â”œâ”€ ä¿å­˜åˆ° presentation è¡¨
    â””â”€ æ›´æ–° thumbnailUrl
    â†“
ç”¨æˆ·åœ¨å†å²è®°å½•ä¸­æŸ¥çœ‹å’Œç¼–è¾‘
```

## ğŸ›¡ï¸ å®‰å…¨ä¸å®¹é”™

### å®‰å…¨æªæ–½
- âœ… æ‰€æœ‰æ“ä½œéœ€è¦ç”¨æˆ·ç™»å½•
- âœ… ç”¨æˆ·åªèƒ½ä¿å­˜è‡ªå·±ç”Ÿæˆçš„å›¾ç‰‡
- âœ… æ–‡ä»¶æŒ‰ç”¨æˆ·IDéš”ç¦»å­˜å‚¨
- âœ… R2 å‡­è¯é€šè¿‡ç¯å¢ƒå˜é‡æˆ–æ•°æ®åº“åŠ å¯†å­˜å‚¨

### å®¹é”™æœºåˆ¶
- âœ… R2 æœªé…ç½®æ—¶ï¼Œè‡ªåŠ¨é™çº§ä½¿ç”¨ä¸´æ—¶ URL
- âœ… ä¿å­˜å¤±è´¥æ—¶ï¼Œä¸å½±å“ç”¨æˆ·çœ‹åˆ°ä¸´æ—¶å›¾ç‰‡
- âœ… æ‰€æœ‰å¼‚å¸¸éƒ½æœ‰ try-catch æ•è·
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜

## ğŸ“Š å­˜å‚¨ç»“æ„

```
studyhacks-ppt/
â”œâ”€â”€ infographic/
â”‚   â”œâ”€â”€ user_abc123/
â”‚   â”‚   â”œâ”€â”€ 1703001234567_a1b2c3d4_0.png
â”‚   â”‚   â”œâ”€â”€ 1703001234567_a1b2c3d4_1.png
â”‚   â”‚   â””â”€â”€ 1703001234568_e5f6g7h8_0.png
â”‚   â””â”€â”€ user_xyz789/
â”‚       â””â”€â”€ ...
â””â”€â”€ slides/
    â”œâ”€â”€ user_abc123/
    â”‚   â”œâ”€â”€ 1703001234567_i9j0k1l2_0.png
    â”‚   â”œâ”€â”€ 1703001234567_i9j0k1l2_1.png
    â”‚   â”œâ”€â”€ 1703001234567_i9j0k1l2_2.png
    â”‚   â””â”€â”€ ...
    â””â”€â”€ user_xyz789/
        â””â”€â”€ ...
```

## ğŸ” ç›‘æ§ä¸è°ƒè¯•

### æ—¥å¿—å…³é”®è¯

**Infographic æ—¥å¿—**ï¼š
```
[Infographic] å¼€å§‹ä¿å­˜ N å¼ å›¾ç‰‡åˆ° R2
[Infographic] ä¿å­˜å›¾ç‰‡ 1: infographic/user123/xxx.png
[Infographic] âœ… å›¾ç‰‡ 1 ä¿å­˜æˆåŠŸ
[Infographic] ä¿å­˜å®Œæˆï¼ŒæˆåŠŸ M/N å¼ 
[Infographic] âœ… å·²æ›´æ–° ai_task è®°å½•
[Infographic] âš ï¸ æœªæ‰¾åˆ°å¯¹åº”çš„ ai_task è®°å½•
```

**Slides æ—¥å¿—**ï¼š
```
[Slides] å¼€å§‹ä¿å­˜ N å¼ å›¾ç‰‡åˆ° R2
[Slides] ä¿å­˜å›¾ç‰‡ 1: slides/user123/xxx.png
[Slides] âœ… å›¾ç‰‡ 1 ä¿å­˜æˆåŠŸ
[Slides] ä¿å­˜å®Œæˆï¼ŒæˆåŠŸ M/N å¼ 
[Slides] ç”¨æˆ·æœªç™»å½•ï¼Œè·³è¿‡ R2 ä¿å­˜
[Slides] R2 æœªé…ç½®ï¼Œè·³è¿‡ä¿å­˜
```

### æ•°æ®åº“éªŒè¯

**æ£€æŸ¥ ai_task è¡¨**ï¼ˆInfographicï¼‰ï¼š
```sql
SELECT id, taskResult, status 
FROM ai_task 
WHERE scene = 'ai_infographic' 
ORDER BY createdAt DESC 
LIMIT 10;
```

æŸ¥çœ‹ `taskResult` å­—æ®µæ˜¯å¦åŒ…å« R2 URLï¼š
```json
{
  "imageUrls": ["https://r2.example.com/infographic/..."],
  "originalUrls": ["https://replicate.com/..."],
  "savedToR2": true,
  "savedAt": "2025-01-01T00:00:00.000Z"
}
```

**æ£€æŸ¥ presentation è¡¨**ï¼ˆSlidesï¼‰ï¼š
```sql
SELECT id, content, thumbnailUrl, status 
FROM presentation 
ORDER BY createdAt DESC 
LIMIT 10;
```

æŸ¥çœ‹ `content` å­—æ®µä¸­çš„ `imageUrl` æ˜¯å¦ä¸º R2 URLã€‚

## ğŸš€ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### ç¯å¢ƒå˜é‡é…ç½®
- [ ] å·²åœ¨ `.env.local` æˆ–ç”Ÿäº§ç¯å¢ƒé…ç½® R2 å‡­è¯
- [ ] `R2_ACCOUNT_ID` - Cloudflare è´¦æˆ·ID
- [ ] `R2_ACCESS_KEY` - R2 Access Key ID
- [ ] `R2_SECRET_KEY` - R2 Secret Access Key
- [ ] `R2_BUCKET_NAME` - æ¡¶åç§°ï¼ˆstudyhacks-pptï¼‰
- [ ] `R2_DOMAIN` - è‡ªå®šä¹‰åŸŸåï¼ˆå¯é€‰ï¼‰

### Cloudflare R2 è®¾ç½®
- [ ] å·²åˆ›å»º R2 æ¡¶ï¼š`studyhacks-ppt`
- [ ] å·²åˆ›å»º API Token
- [ ] å·²é…ç½®å…¬å…±è®¿é—®æƒé™ï¼ˆå¦‚æœéœ€è¦ç›´æ¥è®¿é—®ï¼‰
- [ ] å·²è®¾ç½® CORS è§„åˆ™ï¼ˆå¦‚æœéœ€è¦è·¨åŸŸè®¿é—®ï¼‰

### ä»£ç éƒ¨ç½²
- [ ] å·²éƒ¨ç½²æ–°çš„ APIï¼š`/api/storage/save-ai-image`
- [ ] å·²æ›´æ–° Infographic æŸ¥è¯¢ API
- [ ] å·²æ›´æ–° Slides æŸ¥è¯¢ Action
- [ ] å·²é‡å¯æœåŠ¡

### åŠŸèƒ½æµ‹è¯•
- [ ] æµ‹è¯• Infographic ç”Ÿæˆå’Œä¿å­˜
- [ ] æµ‹è¯• Slides/PPT ç”Ÿæˆå’Œä¿å­˜
- [ ] æ£€æŸ¥ç”Ÿæˆå†å²é¡µé¢
- [ ] éªŒè¯æ•°æ®åº“è®°å½•
- [ ] æŸ¥çœ‹ R2 æ¡¶ä¸­çš„æ–‡ä»¶

## ğŸ’° æˆæœ¬ä¼°ç®—

### Cloudflare R2 å®šä»·
- **å­˜å‚¨**: $0.015/GB/æœˆï¼ˆå‰ 10GB å…è´¹ï¼‰
- **Class A æ“ä½œ**ï¼ˆå†™å…¥ï¼‰: $4.50/ç™¾ä¸‡æ¬¡è¯·æ±‚
- **Class B æ“ä½œ**ï¼ˆè¯»å–ï¼‰: $0.36/ç™¾ä¸‡æ¬¡è¯·æ±‚
- **æµé‡**: **å®Œå…¨å…è´¹**ï¼ˆè¿™æ˜¯ R2 çš„æœ€å¤§ä¼˜åŠ¿ï¼ï¼‰

### ä½¿ç”¨é‡ä¼°ç®—ï¼ˆæ¯æœˆï¼‰
å‡è®¾ï¼š
- 1000 ä¸ªç”¨æˆ·
- æ¯äººç”Ÿæˆ 10 ä¸ª Infographicï¼ˆæ¯ä¸ª 1MBï¼‰
- æ¯äººç”Ÿæˆ 5 ä¸ª PPTï¼ˆæ¯ä¸ª 5 å¼ å›¾ï¼Œæ¯å¼  500KBï¼‰

å­˜å‚¨ç©ºé—´ï¼š
- Infographic: 1000 Ã— 10 Ã— 1MB = 10GB
- Slides: 1000 Ã— 5 Ã— 5 Ã— 0.5MB = 12.5GB
- æ€»è®¡: 22.5GB

è´¹ç”¨ï¼š
- å­˜å‚¨: (22.5 - 10) Ã— $0.015 = $0.1875/æœˆ
- å†™å…¥: (1000 Ã— 10 + 1000 Ã— 25) / 1,000,000 Ã— $4.50 â‰ˆ $0.16/æœˆ
- è¯»å–: å¯å¿½ç•¥ä¸è®¡
- **æ€»è®¡: çº¦ $0.35/æœˆ**

å¯¹æ¯” AWS S3 åŒæ ·ä½¿ç”¨ï¼š
- å­˜å‚¨: 22.5 Ã— $0.023 = $0.52/æœˆ
- æµé‡ï¼ˆå‡è®¾ 100GBï¼‰: 100 Ã— $0.09 = $9/æœˆ
- **æ€»è®¡: çº¦ $9.52/æœˆ**

**R2 èŠ‚çœ 96% çš„æˆæœ¬ï¼**

## ğŸ“š ç›¸å…³èµ„æº

- [Cloudflare R2 æ–‡æ¡£](https://developers.cloudflare.com/r2/)
- [R2 å®šä»·](https://www.cloudflare.com/products/r2/)
- [aws4fetch](https://github.com/mhart/aws4fetch) - R2 ä½¿ç”¨çš„ç­¾ååº“
- é¡¹ç›®ä»£ç ï¼š
  - Storage ç›¸å…³: `src/extensions/storage/`
  - Infographic API: `src/app/api/infographic/`
  - Slides Action: `src/app/actions/aippt.ts`

## âœ¨ æ€»ç»“

æœ¬æ¬¡å®æ–½å®Œæˆäº† Infographic å’Œ Slides/PPT çš„æŒä¹…åŒ–å­˜å‚¨åŠŸèƒ½ï¼Œä¸»è¦ç‰¹ç‚¹ï¼š

1. **è‡ªåŠ¨åŒ–**: ç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œæ‰€æœ‰ä¿å­˜æ“ä½œåœ¨åå°è‡ªåŠ¨å®Œæˆ
2. **å¯é æ€§**: æ™ºèƒ½é™çº§æœºåˆ¶ï¼Œç¡®ä¿ä¸å½±å“ç”¨æˆ·ä½“éªŒ
3. **ç»æµæ€§**: ä½¿ç”¨ Cloudflare R2ï¼Œæˆæœ¬æä½
4. **å®‰å…¨æ€§**: ç”¨æˆ·æ•°æ®éš”ç¦»ï¼Œæƒé™éªŒè¯å®Œå–„
5. **å¯æ‰©å±•**: æ”¯æŒå¤šç§å­˜å‚¨æä¾›å•†ï¼Œæ˜“äºæ‰©å±•

ç”¨æˆ·ç°åœ¨å¯ä»¥åœ¨ç”Ÿæˆå†å²ä¸­æ°¸ä¹…æŸ¥çœ‹å’Œç®¡ç†è‡ªå·±çš„ä½œå“ï¼ğŸ‰

