# PPTX å¯¼å‡ºåŠŸèƒ½å‡çº§æ–‡æ¡£

## é¡¹ç›®ç›®æ ‡
åƒ https://aippt.wps.cn ä¸€æ ·ï¼Œå°†ç”Ÿæˆçš„ PPT å›¾ç‰‡è½¬æ¢ä¸ºå¯ç¼–è¾‘çš„ PPTX æ ¼å¼
- âœ… æ–‡æœ¬å¯ç¼–è¾‘
- âœ… å­—ä½“è¿˜åŸå‡†ç¡®
- âœ… å›¾å±‚å¯åˆ†ç¦»
- âœ… å›¾æ ‡ã€å›¾å½¢å¯åˆ†ç¦»

---

## âœ… å·²å®Œæˆçš„ä¿®æ”¹ï¼ˆ2026-01-20 æ›´æ–°ï¼‰

### ç¬¬äº”é˜¶æ®µä¿®æ”¹ï¼ˆæœ¬æ¬¡å®Œæˆï¼‰âœ…

#### 1. ä» Replicate è¿ç§»åˆ° fal.ai inpaint API âœ…
**æ–‡ä»¶ï¼š** `src/app/api/image/clean-background/route.ts`

**é—®é¢˜ï¼š** Replicate `zylim0702/remove-object` æ¨¡å‹æ— æ³•æ­£ç¡®å¤„ç† data URL æ ¼å¼çš„ mask
```
Prediction failed: cannot identify image file '/tmp/tmpgvzdy4jsfile.svg'
```

**è§£å†³æ–¹æ¡ˆï¼š** è¿ç§»åˆ° fal.ai inpaint API
- ä½¿ç”¨ `fal-ai/inpaint` æ¨¡å‹ï¼ˆåŸºäº Stable Diffusion SDXLï¼‰
- fal.ai å·²åœ¨é¡¹ç›®ä¸­é›†æˆï¼ŒAPI æ›´å¯é 
- æ”¯æŒ data URL æ ¼å¼çš„ mask è¾“å…¥

**ğŸ’° æˆæœ¬ä¼°ç®—ï¼š**
| é¡¹ç›® | æˆæœ¬ |
|------|------|
| fal-ai/inpaint | ~$0.02/megapixel |
| 1920x1080 å›¾ç‰‡ | ~$0.04/å¼  |
| 10 å¼ å¹»ç¯ç‰‡ PPT | ~$0.40 |

**å…³é”®ä»£ç å˜æ›´ï¼š**
```javascript
import { fal } from '@fal-ai/client';

// é…ç½® fal.ai
fal.config({ credentials: process.env.FAL_KEY });

// è°ƒç”¨ inpaint API
const result = await fal.subscribe('fal-ai/inpaint', {
  input: {
    image_url: imageUrl,
    mask_url: maskDataUrl,  // PNG æ ¼å¼ data URL
    prompt: 'clean background, seamless fill, consistent lighting',
    num_inference_steps: 30,
    guidance_scale: 7.5,
  },
});
```

---

### ç¬¬å››é˜¶æ®µä¿®æ”¹ï¼ˆä¹‹å‰å®Œæˆï¼‰

#### 1. ä¿®å¤ Mask æ ¼å¼é”™è¯¯ + æ›´æ¢ä¸º LaMa æ¨¡å‹ âœ…
**æ–‡ä»¶ï¼š** `src/app/api/image/clean-background/route.ts`

**é—®é¢˜ 1ï¼š** SVG mask æ ¼å¼ä¸å…¼å®¹
```
Prediction failed: cannot identify image file '/tmp/tmpgvzdy4jsfile.svg'
```
- åŸå› ï¼šReplicate æ¨¡å‹ä¸æ”¯æŒ SVG æ ¼å¼çš„ maskï¼Œéœ€è¦ PNG æ ¼å¼
- è§£å†³ï¼šä½¿ç”¨ sharp å°† SVG è½¬æ¢ä¸º PNG

**é—®é¢˜ 2ï¼š** stability-ai æ¨¡å‹éœ€è¦ promptï¼Œä¸é€‚åˆçº¯å¯¹è±¡ç§»é™¤

**ä¹‹å‰æ–¹æ¡ˆï¼ˆå·²å¼ƒç”¨ï¼‰ï¼š** LaMa æ¨¡å‹
- æ¨¡å‹ï¼š`zylim0702/remove-object`
- é—®é¢˜ï¼šä»ç„¶æ— æ³•æ­£ç¡®å¤„ç† data URL æ ¼å¼çš„ mask

---

### ç¬¬ä¸‰é˜¶æ®µä¿®æ”¹ï¼ˆä¹‹å‰å®Œæˆï¼‰

#### 1. å¢å¼º Inpainting æµç¨‹æ—¥å¿—å’Œé”™è¯¯å¤„ç† âœ…
**æ–‡ä»¶ï¼š** `src/app/[locale]/(landing)/slides2/slides2-client.tsx`

**ä¿®æ”¹å†…å®¹ï¼š**
- æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼Œè¿½è¸ª inpainting æ‰§è¡Œæƒ…å†µ
- ä¿å­˜åŸå§‹ URL ç”¨äºå¯¹æ¯”ï¼ŒéªŒè¯èƒŒæ™¯æ˜¯å¦è¢«æ¸…ç†
- å¤±è´¥æ—¶æ˜¾ç¤º toast è­¦å‘Šï¼ˆè€Œéé™é»˜å¤±è´¥ï¼‰
- è®°å½• API å“åº”çŠ¶æ€å’Œè¯¦ç»†ä¿¡æ¯

**å…³é”®æ—¥å¿—ç‚¹ï¼š**
```
[PPTX] ========== å¹»ç¯ç‰‡ 1 èƒŒæ™¯æ¸…ç†å¼€å§‹ ==========
[PPTX] åŸå›¾ URL: ...
[PPTX] æ£€æµ‹åˆ° 5 ä¸ªæ–‡æœ¬åŒºåŸŸéœ€è¦æ¸…ç†
[PPTX] clean-background API å“åº”çŠ¶æ€: 200
[PPTX] âœ… å¹»ç¯ç‰‡ 1 èƒŒæ™¯æ¸…ç†æˆåŠŸï¼
[PPTX] èƒŒæ™¯æ˜¯å¦è¢«æ¸…ç†: true
```

#### 2. å¢å¼º clean-background API æ—¥å¿— âœ…
**æ–‡ä»¶ï¼š** `src/app/api/image/clean-background/route.ts`

**ä¿®æ”¹å†…å®¹ï¼š**
- æ·»åŠ è¯·æ±‚å¼€å§‹å’Œç»“æŸçš„åˆ†éš”æ—¥å¿—
- è®°å½•è¾“å…¥å‚æ•°è¯¦æƒ…ï¼ˆURL é•¿åº¦ã€æ–‡æœ¬æ¡†æ•°é‡ã€å›¾ç‰‡å°ºå¯¸ï¼‰
- è®°å½• mask ç”Ÿæˆè¿‡ç¨‹
- è®°å½• Replicate API è°ƒç”¨è€—æ—¶
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼ˆç±»å‹ã€æ¶ˆæ¯ã€å †æ ˆï¼‰

#### 3. å‡å°‘æ–‡æœ¬æ¡†ç¼“å†²åˆ° 2% âœ…
**æ–‡ä»¶ï¼š** `src/app/[locale]/(landing)/slides2/slides2-client.tsx:1620-1636`

**ä¿®æ”¹å†…å®¹ï¼š**
- æ–‡æœ¬æ¡†å®½åº¦ç¼“å†²ä» 5% å‡å°‘åˆ° 2%
- æ–‡æœ¬æ¡†é«˜åº¦ç¼“å†²ä» 5% å‡å°‘åˆ° 2%
- æé«˜æ–‡å­—ä½ç½®è¿˜åŸç²¾åº¦

```javascript
pptSlide.addText(block.text, {
  w: (coords.w || 1) * 1.02,  // ä» 1.05 æ”¹ä¸º 1.02
  h: (coords.h || 0.5) * 1.02,  // ä» 1.05 æ”¹ä¸º 1.02
  // ...
});
```

#### 4. ä¼˜åŒ– OCR æç¤ºè¯æé«˜ bbox ç²¾åº¦ âœ…
**æ–‡ä»¶ï¼š** `src/app/api/ai/ocr-with-positions/route.ts:67-138`

**ä¿®æ”¹å†…å®¹ï¼š**
- å¼ºè°ƒåƒç´ çº§ç²¾ç¡®å®šä½è¦æ±‚
- æ˜ç¡®è¯´æ˜ä¸è¦æ·»åŠ é¢å¤– paddingï¼ˆç”±ç¨‹åºæ·»åŠ ï¼‰
- æä¾›è¯¦ç»†çš„æµ‹é‡æŠ€æœ¯è¯´æ˜
- æ·»åŠ è´¨é‡æ£€æŸ¥æ¸…å•
- æ”¹è¿›ç¤ºä¾‹ JSON çš„åæ ‡å€¼

**å…³é”®æ”¹è¿›ï¼š**
```
âš ï¸ CRITICAL PRECISION RULES:
- x: The EXACT horizontal pixel position where the FIRST character STARTS
- y: The EXACT vertical pixel position where the TOP of the text STARTS
- width: EXACT width from first character's left edge to last character's right edge
- DO NOT add extra padding - we will add it programmatically
```

### ç¬¬äºŒé˜¶æ®µä¿®æ”¹ï¼ˆä¹‹å‰å®Œæˆï¼‰
| ä¿®æ”¹é¡¹ | æ–‡ä»¶ | è¯´æ˜ |
|--------|------|------|
| å­—å·è½¬æ¢ä¼˜åŒ– | `ocr-utils.ts:127-143` | ä½¿ç”¨åˆ†æ®µè½¬æ¢æ¯”ä¾‹ï¼šå°å­—0.55ï¼Œä¸­ç­‰0.6ï¼Œå¤§å­—0.65 |
| åæ ‡æ”¯æŒå¯¹é½æ–¹å¼ | `ocr-utils.ts:154-184` | æ ¹æ® alignment è°ƒæ•´æ–‡æœ¬æ¡†ä½ç½® |
| å›¾å½¢æ£€æµ‹ API | `detect-graphics/route.ts` | æ£€æµ‹å›¾æ ‡ã€å›¾å½¢ã€å›¾è¡¨ç­‰å…ƒç´  |
| å›¾å½¢è£å‰ª API | `crop/route.ts` | ä½¿ç”¨ sharp è£å‰ªå›¾å½¢å…ƒç´  |
| èƒŒæ™¯æ”¹ä¸ºå¯ç¼–è¾‘å›¾ç‰‡ | `slides2-client.tsx:1516-1523` | ä» `background` æ”¹ä¸º `addImage()` |

### ç¬¬ä¸€é˜¶æ®µä¿®æ”¹ï¼ˆä¹‹å‰å®Œæˆï¼‰
| ä¿®æ”¹é¡¹ | æ–‡ä»¶ | è¯´æ˜ |
|--------|------|------|
| ä¿®å¤æ–‡æœ¬æ¡†ç™½è‰²è¾¹æ¡† | `slides2-client.tsx` | å®Œå…¨ç§»é™¤ line å±æ€§ï¼Œä¿æŒ fill: { type: 'none' } |
| ä¿®å¤æ–‡å­—é¢œè‰²è¿˜åŸ | `slides2-client.tsx` | æ·»åŠ é¢œè‰²æ ¼å¼éªŒè¯ï¼Œæ— æ•ˆé¢œè‰²é™çº§ä¸ºé»‘è‰² |

---

## ğŸ”„ PPTX å¯¼å‡ºæµç¨‹ï¼ˆå®Œæ•´ç‰ˆï¼‰

```
ç”¨æˆ·ç‚¹å‡»"å¯¼å‡º PPTX"
    â†“
éå†æ¯å¼ å¹»ç¯ç‰‡
    â†“
æ­¥éª¤1: OCR æ–‡æœ¬æ£€æµ‹
    - è°ƒç”¨ /api/ai/ocr-with-positions
    - æå–æ–‡æœ¬å†…å®¹ã€ä½ç½®ã€é¢œè‰²ã€å­—å·ç­‰
    - ä½¿ç”¨åƒç´ çº§ç²¾ç¡®å®šä½æç¤ºè¯
    â†“
æ­¥éª¤2: èƒŒæ™¯æ¸…ç† â­ å…³é”®æ­¥éª¤
    - è°ƒç”¨ /api/image/clean-background
    - ä½¿ç”¨ inpainting ç§»é™¤èƒŒæ™¯ä¸Šçš„æ–‡å­—
    - è¯¦ç»†æ—¥å¿—è®°å½•æ‰§è¡Œæƒ…å†µ
    - å¤±è´¥æ—¶æ˜¾ç¤ºè­¦å‘Š
    â†“
æ­¥éª¤3: æ·»åŠ æ°´å°ï¼ˆå¯é€‰ï¼‰
    - å¦‚æœå¼€å¯æ°´å°ï¼Œæ·»åŠ åˆ°èƒŒæ™¯å›¾
    â†“
æ­¥éª¤4: è®¾ç½®èƒŒæ™¯å›¾
    - ä½¿ç”¨ addImage() æ·»åŠ å¯ç¼–è¾‘èƒŒæ™¯
    â†“
æ­¥éª¤5: æ£€æµ‹å¹¶æ·»åŠ å›¾å½¢å…ƒç´ 
    - è°ƒç”¨ /api/ai/detect-graphics æ£€æµ‹å›¾æ ‡/å›¾å½¢
    - è°ƒç”¨ /api/image/crop è£å‰ªæ¯ä¸ªå›¾å½¢
    - æŒ‰ zIndex æ’åºåæ·»åŠ ä¸ºç‹¬ç«‹å›¾å±‚
    â†“
æ­¥éª¤6: æ·»åŠ æ–‡æœ¬æ¡†
    - æ ¹æ® OCR ç»“æœæ·»åŠ å¯ç¼–è¾‘æ–‡æœ¬æ¡†
    - é€æ˜èƒŒæ™¯ã€æ— è¾¹æ¡†ã€2% å°ºå¯¸ç¼“å†²
    â†“
ç”Ÿæˆ PPTX æ–‡ä»¶å¹¶ä¸‹è½½
```

---

## ğŸ“Š è°ƒè¯•æŒ‡å—

### éªŒè¯ Inpainting æ˜¯å¦æ‰§è¡Œ
åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹ä»¥ä¸‹æ—¥å¿—ï¼š
```
[PPTX] ========== å¹»ç¯ç‰‡ 1 èƒŒæ™¯æ¸…ç†å¼€å§‹ ==========
[PPTX] åŸå›¾ URL: https://...
[PPTX] æ£€æµ‹åˆ° 5 ä¸ªæ–‡æœ¬åŒºåŸŸéœ€è¦æ¸…ç†
[CLEAN-BG] ========== å¼€å§‹å¤„ç†èƒŒæ™¯æ¸…ç†è¯·æ±‚ ==========
[CLEAN-BG] âœ… å¼€å§‹æ¸…ç†èƒŒæ™¯ï¼Œéœ€è¦ç§»é™¤ 5 ä¸ªæ–‡æœ¬åŒºåŸŸ...
[CLEAN-BG] æ­£åœ¨ç”Ÿæˆ mask...
[CLEAN-BG] âœ… Mask ç”Ÿæˆå®Œæˆ
[CLEAN-BG] æ­£åœ¨è°ƒç”¨ Replicate zylim0702/remove-object (LaMa)...
[CLEAN-BG] âœ… Replicate è°ƒç”¨å®Œæˆï¼Œè€—æ—¶: 3500ms
[CLEAN-BG] âœ… æˆåŠŸï¼
[PPTX] âœ… å¹»ç¯ç‰‡ 1 èƒŒæ™¯æ¸…ç†æˆåŠŸï¼
[PPTX] èƒŒæ™¯æ˜¯å¦è¢«æ¸…ç†: true
```

### å¸¸è§é—®é¢˜æ’æŸ¥
1. **"èƒŒæ™¯æ˜¯å¦è¢«æ¸…ç†: false"** â†’ Inpainting å¤±è´¥ï¼Œæ£€æŸ¥ Replicate API Token
2. **"OCR æœªæ£€æµ‹åˆ°æ–‡æœ¬"** â†’ OCR API é—®é¢˜ï¼Œæ£€æŸ¥ OpenRouter API Key
3. **"Replicate API Token æœªé…ç½®"** â†’ éœ€è¦è®¾ç½® REPLICATE_API_TOKEN ç¯å¢ƒå˜é‡

---

## ğŸ“ ç›¸å…³æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ [locale]/
â”‚   â”‚   â””â”€â”€ (landing)/
â”‚   â”‚       â””â”€â”€ slides2/
â”‚   â”‚           â””â”€â”€ slides2-client.tsx    # ä¸»è¦å¯¼å‡ºé€»è¾‘ï¼ˆå·²æ›´æ–°ï¼‰
â”‚   â””â”€â”€ api/
â”‚       â”œâ”€â”€ ai/
â”‚       â”‚   â”œâ”€â”€ ocr-with-positions/
â”‚       â”‚   â”‚   â””â”€â”€ route.ts              # OCR æ–‡æœ¬ä½ç½®æ£€æµ‹ï¼ˆå·²ä¼˜åŒ–æç¤ºè¯ï¼‰
â”‚       â”‚   â””â”€â”€ detect-graphics/
â”‚       â”‚       â””â”€â”€ route.ts              # å›¾å½¢æ£€æµ‹ API
â”‚       â””â”€â”€ image/
â”‚           â”œâ”€â”€ clean-background/
â”‚           â”‚   â””â”€â”€ route.ts              # èƒŒæ™¯æ¸…ç† APIï¼ˆå·²å¢å¼ºæ—¥å¿—ï¼‰
â”‚           â””â”€â”€ crop/
â”‚               â””â”€â”€ route.ts              # å›¾å½¢è£å‰ª API
â””â”€â”€ shared/
    â””â”€â”€ lib/
        â””â”€â”€ ocr-utils.ts                  # OCR å·¥å…·å‡½æ•°
```

---

## ğŸ“ æµ‹è¯•æ¸…å•

### åŸºç¡€åŠŸèƒ½æµ‹è¯•
- [x] æ–‡å­—é¢œè‰²æ­£ç¡®è¿˜åŸ
- [x] æ–‡å­—åœ¨ä¸€è¡Œæ˜¾ç¤ºï¼ˆä¸æ¢è¡Œï¼‰
- [x] æ–‡æœ¬æ¡†æ— ç™½è‰²è¾¹æ¡†
- [x] æ–‡æœ¬æ¡†èƒŒæ™¯é€æ˜
- [x] ä¸­è‹±æ–‡å­—ä½“æ­£ç¡®é€‰æ‹©

### æœ¬æ¬¡ä¿®å¤éªŒè¯
- [ ] æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤ºè¯¦ç»†çš„ inpainting æ—¥å¿—
- [ ] èƒŒæ™¯æ–‡å­—å·²è¢«æ¸…é™¤ï¼ˆå¹²å‡€çš„èƒŒæ™¯ï¼‰
- [ ] æ–‡å­—ä½ç½®æ›´å‡†ç¡®ï¼ˆåç§»é‡å‡å°‘ï¼‰
- [ ] å¤±è´¥æ—¶æœ‰ toast æç¤ºï¼ˆéé™é»˜å¤±è´¥ï¼‰

### è¿›é˜¶æµ‹è¯•
- [ ] æµ‹è¯•åŒ…å«å¤šä¸ªå›¾æ ‡çš„å¹»ç¯ç‰‡
- [ ] æµ‹è¯•å¤æ‚èƒŒæ™¯çš„å¹»ç¯ç‰‡
- [ ] æµ‹è¯•å›¾è¡¨ç±»å¹»ç¯ç‰‡
- [ ] æµ‹è¯•çº¯æ–‡å­—å¹»ç¯ç‰‡
- [ ] æµ‹è¯•ä¸­è‹±æ–‡æ··åˆå†…å®¹

---

## ğŸ“š å‚è€ƒèµ„æ–™
- [pptxgenjs æ–‡æ¡£](https://gitbrent.github.io/PptxGenJS/)
- [fal.ai Inpaint API](https://fal.ai/models/fal-ai/inpaint/api)
- [fal.ai å®šä»·](https://fal.ai/pricing)
- [OpenRouter API æ–‡æ¡£](https://openrouter.ai/docs)
- [Sharp å›¾ç‰‡å¤„ç†åº“](https://sharp.pixelplumbing.com/)

---

*æœ€åæ›´æ–°: 2026-01-20*
*çŠ¶æ€: âœ… ç¬¬äº”è½®ä¼˜åŒ–å®Œæˆï¼ˆè¿ç§»åˆ° fal.ai inpaint APIï¼‰*