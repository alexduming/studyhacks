# R2 持久化存储配置说明

## 🎯 功能说明

系统已实现将 AI 生成的 **Infographic** 和 **Slides/PPT** 自动保存到 Cloudflare R2 存储，确保作品永久可访问。

### 存储结构

```
studyhacks-ppt/
├── infographic/    # Infographic 存储在这里
│   └── {用户ID}/
└── slides/         # PPT 幻灯片存储在这里
    └── {用户ID}/
```

## 📝 配置步骤

### 方法一：环境变量配置（推荐）

在 `.env.local` 文件中添加：

```env
# 你的 R2 配置信息（来自 Cloudflare Dashboard）
R2_ACCOUNT_ID=你的账户ID
R2_ACCESS_KEY=你的访问密钥ID
R2_SECRET_KEY=你的密钥
R2_BUCKET_NAME=studyhacks-ppt

# 可选：自定义域名
R2_DOMAIN=https://cdn.yourdomain.com
```

### 方法二：后台配置

1. 登录管理后台
2. **Settings** → **Storage** 标签
3. 填写 **R2 Storage** 配置组的所有字段

## 🔑 获取 R2 凭证

1. 访问 [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. 进入 **R2** 页面
3. 创建桶名称：`studyhacks-ppt`
4. 进入 **R2 API Tokens** 创建 API Token
5. 复制 Account ID、Access Key、Secret Key

## ✅ 工作流程

### Infographic 生成流程：

1. 用户在 `/infographic` 页面生成图片
2. 系统调用 AI 提供商（Replicate/KIE/Together/Novita）生成图片
3. **✨ 查询任务完成后，自动下载并上传到 R2**
4. 更新 `ai_task` 表，保存 R2 永久 URL
5. 用户在历史记录中看到永久保存的作品

### Slides/PPT 生成流程：

1. 用户在 `/slides` 页面生成 PPT
2. 系统为每张幻灯片调用 AI 生成图片
3. **✨ 每张图片生成完成后，自动下载并上传到 R2**
4. 保存到 `presentation` 表的 `content` 字段
5. 用户可以在生成历史中查看和编辑

## 🛡️ 容错机制

- ✅ 如果 R2 未配置：使用临时 URL（几小时后可能失效）
- ✅ 如果保存失败：使用临时 URL，不影响用户使用
- ✅ 所有操作都有详细日志，方便排查问题

## 💰 费用说明

Cloudflare R2 费用极低：

- **前 10GB/月 免费**
- 超出部分：$0.015/GB/月
- **无流量费用**（这是 R2 的最大优势！）

对于大多数项目来说，基本都在免费额度内。

## 🎨 用户体验

用户完全无感知，所有保存操作在后台自动完成：

- ✨ 生成后立即可见
- 📦 自动永久保存
- 📚 历史记录随时可查
- 🔒 只能访问自己的作品

## 📊 查看保存结果

### 数据库字段：

**ai_task 表**（Infographic）：

```json
{
  "taskResult": {
    "imageUrls": ["https://r2.example.com/infographic/user123/..."],
    "originalUrls": ["https://replicate.com/..."],
    "savedToR2": true,
    "savedAt": "2025-01-01T00:00:00.000Z"
  }
}
```

**presentation 表**（Slides）：

```json
{
  "content": [
    {
      "id": "slide1",
      "title": "标题",
      "content": "内容",
      "imageUrl": "https://r2.example.com/slides/user123/..."
    }
  ]
}
```

## 🔍 日志监控

查看服务器日志，确认保存状态：

```bash
# Infographic 保存日志
[Infographic] 开始保存 1 张图片到 R2
[Infographic] ✅ 图片 1 保存成功

# Slides 保存日志
[Slides] 开始保存 1 张图片到 R2
[Slides] ✅ 图片 1 保存成功
```

## ❓ 常见问题

**Q: 必须配置 R2 吗？**  
A: 不是必须的，但强烈推荐。不配置的话，图片 URL 可能几小时后就失效了。

**Q: 已经生成的历史作品怎么办？**  
A: 老数据需要手动迁移，新生成的内容会自动保存到 R2。

**Q: 可以用 AWS S3 吗？**  
A: 可以，代码已支持 S3，修改配置即可。但 R2 更便宜（无流量费）。

**Q: 保存失败会影响用户吗？**  
A: 不会，系统会自动降级使用临时 URL，用户依然可以看到图片。

## 📞 技术支持

- 配置问题：查看 `docs/R2_STORAGE_SETUP.md`
- 代码位置：
  - R2 Provider: `src/extensions/storage/r2.ts`
  - Infographic API: `src/app/api/infographic/query-with-fallback/route.ts`
  - Slides Action: `src/app/actions/aippt.ts`
- Cloudflare R2 文档: https://developers.cloudflare.com/r2/
