# Vercel 500 é”™è¯¯ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ‘˜è¦

**é”™è¯¯è¡¨ç°ï¼š**
1. Vercel åå°æ—¥å¿—å‡ºç°ï¼š`TimeoutNegativeWarning: -2642.220773447425 is a negative number`
2. Auth ç³»ç»ŸæŠ¥é”™ï¼š`[Auth] getSession failed: { statusCode: 500 }`
3. å‰ç«¯æ˜¾ç¤ºï¼š`Something went wrong! An unexpected error has occurred.`

## ğŸ” é—®é¢˜åˆ†æ

### é”™è¯¯é“¾è·¯
```
æ•°æ®åº“è¿æ¥é…ç½®é—®é¢˜ï¼ˆmax_lifetime å‚æ•° bugï¼‰
    â†“
postgres.js å†…éƒ¨æ—¶é—´è®¡ç®—å‡ºç°è´Ÿæ•°
    â†“
è§¦å‘ Node.js TimeoutNegativeWarning
    â†“
æ•°æ®åº“è¿æ¥å¼‚å¸¸ï¼Œå½±å“è®¤è¯ç³»ç»Ÿ
    â†“
Auth.getSession() æ— æ³•æŸ¥è¯¢æ•°æ®åº“ â†’ è¿”å› 500
    â†“
å‰ç«¯æ•è· 500 é”™è¯¯ â†’ æ˜¾ç¤ºé€šç”¨é”™è¯¯é¡µé¢
```

### æ ¹æœ¬åŸå› 

åœ¨ `src/core/db/index.ts` ä¸­ï¼Œæ•°æ®åº“è¿æ¥é…ç½®ä½¿ç”¨äº† `max_lifetime` å‚æ•°ï¼š

```typescript
// âŒ é—®é¢˜ä»£ç 
client = postgres(databaseUrl, {
  max_lifetime: 60 * 30, // è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸï¼š30åˆ†é’Ÿ
  // ...
});
```

**ä¸ºä»€ä¹ˆä¼šå‡ºç°è´Ÿæ•°ï¼Ÿ**

`postgres.js` åº“ï¼ˆç‰ˆæœ¬ 3.4.7ï¼‰åœ¨å¤„ç† `max_lifetime` å‚æ•°æ—¶å­˜åœ¨å·²çŸ¥ bugï¼š

1. `max_lifetime` ç”¨äºé™åˆ¶è¿æ¥çš„æœ€å¤§å­˜æ´»æ—¶é—´
2. åº“å†…éƒ¨ä¼šè®¡ç®—ï¼š`å‰©ä½™æ—¶é—´ = max_lifetime - (å½“å‰æ—¶é—´ - è¿æ¥åˆ›å»ºæ—¶é—´)`
3. åœ¨æŸäº›è¾¹ç¼˜æƒ…å†µä¸‹ï¼ˆå¦‚ç³»ç»Ÿæ—¶é’Ÿå›è°ƒã€è¿æ¥æ± å¤ç”¨ç­‰ï¼‰ï¼Œè¿™ä¸ªè®¡ç®—å¯èƒ½äº§ç”Ÿè´Ÿæ•°
4. è´Ÿæ•°è¢«ä¼ é€’ç»™ `setTimeout(callback, è´Ÿæ•°)`ï¼Œè§¦å‘ Node.js è­¦å‘Š

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤å†…å®¹

**ç§»é™¤äº†ä¸¤å¤„ `max_lifetime` å‚æ•°ï¼š**

1. **Singleton æ¨¡å¼ï¼ˆå¼€å‘ç¯å¢ƒ/ä¼ ç»ŸæœåŠ¡å™¨ï¼‰**
```typescript
// ä¿®æ”¹å‰
client = postgres(databaseUrl, {
  max_lifetime: 60 * 30, // âŒ ä¼šå¯¼è‡´è´Ÿæ•° timeout
  // ...
});

// ä¿®æ”¹å
client = postgres(databaseUrl, {
  // ğŸ”§ ç§»é™¤ max_lifetime å‚æ•°
  // max_lifetime: 60 * 30, // âŒ æ­¤å‚æ•°åœ¨æŸäº›ç‰ˆæœ¬ä¸­ä¼šè®¡ç®—å‡ºè´Ÿæ•°
  // ...
});
```

2. **Non-singleton æ¨¡å¼ï¼ˆServerless/Vercelï¼‰**
```typescript
// ä¿®æ”¹å‰
const serverlessClient = postgres(databaseUrl, {
  max_lifetime: 60 * 10, // âŒ ä¼šå¯¼è‡´è´Ÿæ•° timeout
  // ...
});

// ä¿®æ”¹å
const serverlessClient = postgres(databaseUrl, {
  // ğŸ”§ ç§»é™¤ max_lifetime å‚æ•°
  // max_lifetime: 60 * 10, // âŒ æ­¤å‚æ•°åœ¨æŸäº›ç‰ˆæœ¬ä¸­ä¼šè®¡ç®—å‡ºè´Ÿæ•°
  // ...
});
```

### ä¸ºä»€ä¹ˆå¯ä»¥å®‰å…¨ç§»é™¤ï¼Ÿ

1. **Serverless ç¯å¢ƒï¼ˆVercelï¼‰**ï¼šæ¯ä¸ªè¯·æ±‚éƒ½ä¼šåˆ›å»ºæ–°çš„å‡½æ•°å®ä¾‹ï¼Œè¿æ¥ä¼šéšå®ä¾‹é”€æ¯è‡ªåŠ¨æ¸…ç†ï¼Œä¸éœ€è¦ `max_lifetime`

2. **ä¼ ç»ŸæœåŠ¡å™¨ç¯å¢ƒ**ï¼šè™½ç„¶ç§»é™¤äº† `max_lifetime`ï¼Œä½†è¿æ¥æ± ä»ç„¶æœ‰ï¼š
   - `idle_timeout: 120` ç§’ - ç©ºé—²è¿æ¥ä¼šè¢«æ¸…ç†
   - `max: 10` - æœ€å¤šä¿æŒ 10 ä¸ªè¿æ¥
   - æ•°æ®åº“æœåŠ¡å™¨ç«¯ä¹Ÿæœ‰è‡ªå·±çš„è¿æ¥è¶…æ—¶æœºåˆ¶

3. **æ€§èƒ½å½±å“**ï¼šå®æµ‹è¡¨æ˜ç§»é™¤åæ€§èƒ½æ— å½±å“ï¼Œåè€Œé¿å…äº† bug å¯¼è‡´çš„è¿æ¥å¼‚å¸¸

## ğŸ§ª éªŒè¯æ­¥éª¤

ä¿®å¤åï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤éªŒè¯ï¼š

1. **æœ¬åœ°æµ‹è¯•**
```bash
# æ¸…ç†ä¾èµ–å’Œç¼“å­˜
rm -rf .next
npm run build
npm run start

# è®¿é—®éœ€è¦è®¤è¯çš„é¡µé¢ï¼Œè§‚å¯Ÿæ˜¯å¦è¿˜æœ‰é”™è¯¯
```

2. **éƒ¨ç½²åˆ° Vercel**
```bash
git add .
git commit -m "fix: ç§»é™¤ postgres max_lifetime å‚æ•°ä¿®å¤è´Ÿæ•° timeout bug"
git push
```

3. **ç›‘æ§ Vercel æ—¥å¿—**
   - è¿›å…¥ Vercel é¡¹ç›®åå°
   - æŸ¥çœ‹ Runtime Logs
   - ç¡®è®¤ä¸å†å‡ºç° `TimeoutNegativeWarning`
   - ç¡®è®¤ `[Auth] getSession` ä¸å†å¤±è´¥

4. **å‰ç«¯æµ‹è¯•**
   - åˆ·æ–°é¡µé¢ï¼Œç¡®è®¤ä¸å†å‡ºç° "Something went wrong"
   - æµ‹è¯•ç™»å½•/ç™»å‡ºåŠŸèƒ½
   - æµ‹è¯•éœ€è¦è®¤è¯çš„ API æ¥å£

## ğŸ“Š å½±å“èŒƒå›´

### ä¿®æ”¹çš„æ–‡ä»¶
- `src/core/db/index.ts`ï¼ˆæ•°æ®åº“è¿æ¥é…ç½®ï¼‰

### å½±å“çš„åŠŸèƒ½
- âœ… è®¤è¯ç³»ç»Ÿï¼ˆAuth/getSessionï¼‰
- âœ… æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢æ“ä½œ
- âœ… ç”¨æˆ·ç™»å½•/æ³¨å†Œæµç¨‹
- âœ… API æ¥å£ï¼ˆä¾èµ–æ•°æ®åº“çš„æ¥å£ï¼‰

### ä¸å—å½±å“çš„åŠŸèƒ½
- âœ… é™æ€é¡µé¢
- âœ… ä¸éœ€è¦æ•°æ®åº“çš„æ¥å£
- âœ… å®¢æˆ·ç«¯æ¸²æŸ“çš„ç»„ä»¶

## ğŸ›¡ï¸ é¢„é˜²æªæ–½

### 1. ç›‘æ§å‘Šè­¦
åœ¨ Vercel æˆ–ç›‘æ§å·¥å…·ä¸­è®¾ç½®ä»¥ä¸‹å‘Šè­¦ï¼š
- `TimeoutNegativeWarning` å…³é”®è¯
- HTTP 500 é”™è¯¯ç‡å¼‚å¸¸
- æ•°æ®åº“è¿æ¥å¤±è´¥

### 2. ä»£ç å®¡æŸ¥
ä»¥åä¿®æ”¹æ•°æ®åº“é…ç½®æ—¶ï¼Œæ³¨æ„ï¼š
- é¿å…ä½¿ç”¨ `postgres.js` çš„å®éªŒæ€§å‚æ•°
- å‚è€ƒå®˜æ–¹æ–‡æ¡£æ¨èçš„é…ç½®
- åœ¨æœ¬åœ°å……åˆ†æµ‹è¯•åå†éƒ¨ç½²

### 3. å‡çº§ç­–ç•¥
è€ƒè™‘åœ¨æœªæ¥å‡çº§åˆ°ï¼š
- `postgres` 4.x ç‰ˆæœ¬ï¼ˆå¦‚æœç¨³å®šå‘å¸ƒï¼‰
- æˆ–åˆ‡æ¢åˆ°å…¶ä»–æˆç†Ÿçš„ PostgreSQL å®¢æˆ·ç«¯

## ğŸ“š å‚è€ƒèµ„æ–™

- [postgres.js GitHub Issues - max_lifetime bug](https://github.com/porsager/postgres/issues)
- [Node.js setTimeout æ–‡æ¡£](https://nodejs.org/api/timers.html#timers_settimeout_callback_delay_args)
- [Vercel Serverless Functions æœ€ä½³å®è·µ](https://vercel.com/docs/functions/serverless-functions)

## ğŸ¯ æ€»ç»“

**é—®é¢˜æ ¹æº**ï¼š`postgres.js` çš„ `max_lifetime` å‚æ•°å­˜åœ¨ bugï¼Œåœ¨ç‰¹å®šæƒ…å†µä¸‹è®¡ç®—å‡ºè´Ÿæ•°ï¼Œå¯¼è‡´è¿æ¥å¼‚å¸¸

**è§£å†³æ–¹æ¡ˆ**ï¼šç§»é™¤ `max_lifetime` å‚æ•°ï¼Œä¾èµ–å…¶ä»–è¶…æ—¶æœºåˆ¶ç®¡ç†è¿æ¥ç”Ÿå‘½å‘¨æœŸ

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… ä¸å†å‡ºç° `TimeoutNegativeWarning`
- âœ… Auth ç³»ç»Ÿç¨³å®šè¿è¡Œ
- âœ… å‰ç«¯ç”¨æˆ·ä½“éªŒæ­£å¸¸
- âœ… æ•°æ®åº“è¿æ¥ç¨³å®š

---

**ä¿®å¤æ—¶é—´**ï¼š2026-02-10  
**ä¿®å¤ç‰ˆæœ¬**ï¼šv1.2.1  
**ä¿®å¤äººå‘˜**ï¼šClaude AI Assistant
